{% extends 'iframe_base.html' %}
{% import 'per/_models.html' as model %}
{% from 'bootstrap/utils.html' import render_static %}
{% block head %}
  <style>
    .per-content {
      height: 100%;
      width: 100%;
    }
    .per-table {
      padding: 1.2rem 1rem;
      width: 100%;
      height: 100%;
    }
    .tab-content {
      width: 100%;
      min-height: 90%;
    }
    .fade {
      width: 100%;
      height: 90%;
    }
    form#add-per {
      width: 100%;
      height: 100%;
    }
    td.index, th.index{
      width: 3em;
      padding-top: 1em;
    }
    table tbody{
      font-size: 0.875rem;
    }
    td.index {
      padding-top: 1.1rem;
    }
    td select {
      min-width: 5rem;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="iframe-content">
    <div class="search d-flex mb-2">
      <div class="title">{{ title }}</div>
    </div>
    <div class="per-content">
      <form id="add-per">
        {% include 'per/infotable.html' %}

        <div class="input-group justify-content-end">
          <button type="submit" class="btn btn-outline-dark
				mr-3">提交</button>
          <button type="reset" class="btn btn-outline-dark
				mr-3">重置</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
{% block script %}
  {{ render_static('js', 'js/per.js') }}
  <script>


  </script>
  <script>
      var temp;

      var f_count = myCount();
      f_count.init({{ f_count|default(0) }});

      var r_and_p_count = myCount();
      r_and_p_count.init({{ r_and_p_count|default(0) }});

      var edu_count = myCount();
      edu_count.init({{ edu_count|default(0) }});

      var title_count = myCount();
      title_count.init({{ title_count|default(0) }});

      var resume_count = myCount();
      resume_count.init({{ resume_count|default(0) }});

      var _edu_lv = [];
      {% for temp in edu_lv %}
          temp = [];
          temp.push({{ temp[0] }});
          temp.push("{{ temp[1] }}");
          _edu_lv.push(temp);
      {% endfor %}

      var _learn_from = [];
      {% for temp in learn_form %}
          temp = [];
          temp.push({{ temp[0] }});
          temp.push("{{ temp[1] }}");
          _learn_from.push(temp);
      {% endfor %}

      var _titles = {};
      {% for title in title_names %}
          _titles["{{ title[0] }}"] = ["{{ title[2] }}", "{{ title[3] }}"];
      {% endfor %}

      var _dept_names = {};
      {% for name in dept_names %}
          _dept_names["{{ name[0] }}"] = ["{{ name[2] }}", "{{ name[3] }}"];
      {% endfor %}

      var title_change = function (id) {
          var tds = $('#'+ id).find('td');
          var title_id = tds.eq(3).find('select').val();
          tds.eq(2).find('input').val(_titles[title_id][1]);
          tds.eq(1).find('input').val(_titles[title_id][0]);
      };

      var dept_name_change = function () {
        var dept_id = $('#dept_name').val();
        $('#system').val(_dept_names[dept_id][0]);
        $('#dept_pro').val(_dept_names[dept_id][1]);
      };

      var title_name = "<td class='input-group-inline input-group-sm'>" +
          "<select class='mt-1'>" +
          {% for title in title_names %}
              "<option value=\"{{ title[0] }}\">{{ title[1] }}</option>" +
          {% endfor %}
          "</select>" +
          "</td>";


      $(document).ready(function () {
          $('.mydate').datepicker({
              language: "zh-CN"
          });

          $('#dept_name').bind('change', dept_name_change);

          // 监听form表单
          $('#add-per').bind('submit', function () {
              var data = JSON.stringify({
                  families: get_families(),
                  r_and_p: get_r_and_p(),
                  edus: get_edu(),
                  titlies: get_title(),
                  resumes: get_resume()
              });

              var _success = function (data) {
                  alert(data.message);
                  location.href = '/search';
              };

              a_json(
                  '/v1/manage-per',
                  'POST',
                  data,
                  _success
              );

              return false;
          })
      });
  </script>

{% endblock %}